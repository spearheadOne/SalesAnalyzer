#!/bin/bash
set -euxo pipefail

DB_NAME="${db_name}"
DB_USER="${db_user}"
DB_PASS="${db_pass}"
VPC_CIDR="${vpc_cidr}"


echo "Installing Docker..."
yum install -y docker
systemctl start docker
systemctl enable docker

echo "Pulling TimescaleDB image..."
docker pull timescale/timescaledb:latest-pg14

echo "Starting TimescaleDB container..."
docker run -d \
  --name timescaledb \
  --restart always \
  -p 5432:5432 \
  -e POSTGRES_DB="$DB_NAME" \
  -e POSTGRES_USER="$DB_USER" \
  -e POSTGRES_PASSWORD="$DB_PASS" \
  -v /var/lib/timescaledb:/var/lib/postgresql/data \
  timescale/timescaledb:latest-pg14

echo "Waiting for TimescaleDB to be ready..."
for i in {1..30}; do
  if docker exec timescaledb pg_isready -U "$DB_USER" &>/dev/null; then
    echo "✓ TimescaleDB is ready!"
    break
  fi
  echo "Waiting... ($i/30)"
  sleep 2
done

echo "Testing connection..."
docker exec timescaledb psql -U "$DB_USER" -d "$DB_NAME" -c "\dx"

echo "=================================================="
echo "✓ TimescaleDB is running!"
echo "=================================================="
echo "Connection: psql -h $(hostname -I | awk '{print $1}') -U $DB_USER -d $DB_NAME"
echo "Password: $DB_PASS"
echo "=================================================="